version: 0.2

env:
  variables:
    VERACODE_WRAPPER_DIR: ".veracode"
    VERACODE_APP_NAME: "verademo-node-js"
    ARTIFACT_S3_BUCKET: "codepipeline-us-east-1-2a0872b75d23-4d62-9226-310ec9012a61"
    ARTIFACT_S3_KEY: "veracode/veracode.zip"

phases:
  install:
    runtime-versions:
      java: corretto11
    commands:
      - echo "Skipping build step (no se requiere compilación)"

  pre_build:
    commands:
      - echo "Descargando artefacto del primer build desde S3..."
      - aws s3 cp s3://$ARTIFACT_S3_BUCKET/$ARTIFACT_S3_KEY ./veracode.zip
      - if [ ! -f veracode.zip ]; then echo "ERROR: veracode.zip no encontrado"; exit 1; fi
      - echo "Preparando directorio del wrapper de Veracode..."
      - mkdir -p $VERACODE_WRAPPER_DIR
      - METADATA_URL="https://repo1.maven.org/maven2/com/veracode/vosp/api/wrappers/vosp-api-wrappers-java/maven-metadata.xml"
      - echo "Descargando metadata: $METADATA_URL"
      - curl -s $METADATA_URL -o metadata.xml
      - VERSION=$(grep -oPm1 "(?<=<latest>)[^<]+" metadata.xml)
      - echo "Última versión detectada: $VERSION"
      - ZIP_URL="https://repo1.maven.org/maven2/com/veracode/vosp/api/wrappers/vosp-api-wrappers-java/$VERSION/vosp-api-wrappers-java-$VERSION-dist.zip"
      - echo "Descargando wrapper: $ZIP_URL"
      - curl -L $ZIP_URL -o $VERACODE_WRAPPER_DIR/dist.zip
      - echo "Extrayendo wrapper..."
      - unzip -o $VERACODE_WRAPPER_DIR/dist.zip -d $VERACODE_WRAPPER_DIR
      - WRAPPER_JAR=$(find $VERACODE_WRAPPER_DIR -name "VeracodeJavaAPI.jar" | head -n 1)
      - if [ -z "$WRAPPER_JAR" ]; then echo "ERROR: No se encontró VeracodeJavaAPI.jar"; exit 1; fi
      - cp "$WRAPPER_JAR" ./VeracodeJavaAPI.jar
      - ls -la ./VeracodeJavaAPI.jar

  build:
    commands:
      - echo "Iniciando upload+scan en Veracode..."
      - |
        java -jar VeracodeJavaAPI.jar \
          -action uploadandscan \
          -appname "$VERACODE_APP_NAME" \
          -createprofile true \
          -version "build-$CODEBUILD_BUILD_ID" \
          -filepath veracode.zip \
          -vid $VERACODE_API_ID \
          -vkey $VERACODE_API_KEY

artifacts:
  files:
    - '**/*'
